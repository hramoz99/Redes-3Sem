Arquitetando o ambiente

 FSMO 

Floresta = conjunto de dominios que confiam uns nos outros

As fsmo são dividas em dois grupos: nivel de floresta (2 fsmo) e em nivel de dominio (3 fsmo)

  Floresta
    . schema Master - O schema é o coração do AD. ele é composto de objetos e atributos que modelam o Active Director. è atraves do Schema que dizemos pór exmplo que o obejto do tip0o usuario tera os atributos nome, endereço, telefone. COmo o esquema pode ser customizado e deve ser o mesmo em toda a floresta windows, a regra Schema Master se encarrega de evitar conflitos entre outros dominios
    
    . Domain Tree (Domain Naming master) - Se voce adiciona um novo dominio em uma floresta (por exemplo, um dominio filho), o nome deste dominio deve ser único na floresta. É esta regra responsavel por assegurar isto e evitar conflitos entre outros dominios

    . PDC como o nome ja diz, uma das funções desta regra é emular um pdc nt 4.0 para manter a compatibilidade com servidores legados e clientes mais antigos . mesmo que voce migre seu ambiente para o windows 2000 ou 2003 esta regra ainda é importante,pois é responsável por tratar alterações de contas de usuarios , lockouts de contas, relações de confianças com outros dominios e pelo sincronismo do relogio no dominio

    . RID qualquer DC pode criar novos objetos. cada objeto deve possuir um identificador único conhecido como SID. O SID do objeto é construido usando o SID de dominio, mais um id relativo (RID). Porém após criar 512 objetos um dc precisa contatar o RID master para conseguir mais de 512 RIds. Isto evitaque dois objetos tenham diferentes o mesmo RID em todo o dominio.
    . Infraestrutura esta regra é muitas vezes conhecida como cosmetica, já que sua função é assegurar que o Display Name de usuarios pertencentes a um grupo sejam atualizados caso este atributo seja alterado. ele é mais importante em ambientes que possuem varios dominios, pois vai asseugurar que todos os grupos que um determinado usuario pertença irá refletir o Display Name correto.



Comando que apresenta os servidores:

      netdom query fsmo 


Obejtos 
 Componentes do AD como usuarios, grupos, impressoras, compartilhamento e podem ser manipulados conforme a necessidade do momento. É importante ressaltar que no windows server 2008 existe uma proteção no momento da criação dos objetos que evita que sejam apagados por engano
 

Unidades Organizacionais (OU/UO)
 .São partições administrativas que permitem o direcionamento relacioando a permissoes de acesso e organizações dos objetos do AD


Base de dados do AD

 Ntds.dit

  O arquivo NTDS.DIT é a base de dados principal do active directory. Este arquivo esta direcionado em dois endereços dentro de um controlador de dominio. Lembre-se desse fator para dio a dia.

   <> %SystemRoot%\NTDS\Ntds.dit
   <> %SystemRoot%\System32\Ntds.dit


NTDSutil.exe é uma ferramenta de linha de comando que oferece recursos de gerenciamento de serviços de dominio AD. Voce pode usar os comandos ntdsutil para realizar a manutenção de banco de dados do Ad Ds, gerenciar e controlar operações de mestre unicas e remover metadados deixados pelos controladores de dominio que foram removidos da rede sem uma desintalção adequada. Esta ferramenta destina-se ao uso por administradores experientes.
Esta ferramenta é extremamente versatil e pode ser utilizada para uma serie de atividades que envolvam o dominio. 



Movendo as FSMO para outro servidor

 abrir prompt de comando > acesso privilegiado (admin) > ntdsutil > roles > connections > connect to domain [nome_deo_dominio] > q > transfer pdc >  transfer rid master > transfer naming master > transfer schema master > transfer infrastructure





limpeza de metadados 

abrir prompt > ndtsutil > metadata cleanup > connections > connect to domain [nome_do_dominio] > q > select operation target > list domains > select domain 0 > list site > select site 0 > list servers in site > select server 2 > q > remove selected server


https://learn.microsoft.com/pt-br/windows-server/identity/ad-ds/deploy/ad-ds-metadata-cleanup




ntds.dit


Este computador >  disco local > windows > ntds > criar uma pasta > abrir o powershell > net stop ntds > abrir o prompt > ntdsutil > activate instance ntds > files > info > compact to c:\[pasta] > net start ntds (no powershell)


https://learn.microsoft.com/en-us/previous-versions/windows/it-pro/windows-2000-server/cc961761(v=technet.10)?redirectedfrom=MSDN
https://learn.microsoft.com/pt-br/troubleshoot/windows-server/identity/ad-database-offline-defragmentation
https://www.ultimatewindowssecurity.com/blog/default.aspx?d=10/2017
https://blog.netwrix.com/2021/11/30/extracting-password-hashes-from-the-ntds-dit-file/



catalogo global

 è um servidor que contem um armazenamento de todos os dominios da floresta respondendo como um catalogo global da floresta
 com o emprego do catalogo global, evitam-se consultas de servidor no active directory até que se encontre o controlador de dominio responsavel pelo objeto procurado
 Apesar dessa função ser instalada automaticamente com o Ad DS, podemos dedicar outro servidor a essa tarefa quando nossa rede é muito grande ou muito complexa. isso pode ajudar em questoes relacionadas a desempenho de uma forma bem interessante

O catalogo global é utilizado para 

   - Porcessamento de logns de usuario, sendo necessario para resolver o quadro de membros de grupos para geração do token de segurança
   - No processamento de logons de usuario que utilizam um UPN (Iniversal Principal Name), lembrando que o UPN fornece o nome de usuario@dominio
   - Na localização de dados do diretorio, independente do dominio da floresta em que estejam
   - Recomenda-se no minimo um catalogo global por site reduzindo o trafego de rede



Protocolos e portas

  LDAP  - UDP 389
  KERBEROS - UDP 88
  GLOBAL CATALOG - TCP 3268
  DNS - TCP 53
  RPC - TCP 135


 Verificar se a porta está on

 (powershell)

 netstat -na |findstr [nº_da_porta]

ou 

 Get -NetTCPConnection -state listen

ou 
  
 Get -NetTCPConnection -state listen -localport [porta(s)]

https://learn.microsoft.com/en-us/previous-versions/windows/it-pro/windows-server-2008-R2-and-2008/dd772723(v=ws.10)?redirectedfrom=MSDN

    
 
 
  
