LOGs de redes 


 Atendimento a LGPD

  Descrição: produção de resgistros de eventos das atividades do usuario, exceções, falhas e eventos de segurança da informação, mantidos e analisados criticamente a intervalos regulares

  justificativa: ter rastreabilidade do ambiente de rede e sistemas atraves de registros de eventos, para investigação de desvios. acessos indevidos ou uso indevido da informaçao de usuarios comuns e usuarios privilegiados


gerenciamento do servidor > gerenciamento de politicas e grupos > botao direito em politica de grupo > editar > configurações de computador > politicas > configurações do windows > configurações de segurança > politica local > politica de auditoria > selecionar somente auditorias necessarias (êxito e falha) 
 



Localizando usuários com criptografia reversível




Gerenciador do servidor > ferramentas > gerenciador de politica de grupo > botao direito sobre GPO > editar > configurações de computadores > politicas > configurações de windows > configurações de seguranca > politica de conta > politica de senha > armazenar senhas usando criptografia reversivel > desabilitar> 

windows poweshell 
 
 Get-ADUser -filter 'userAccountControl -band 128 -Properties USerAccountControl 
Get-ADUser -filter * | Set-ADUSer -AllowReversiblePasswordEncryption $false
 



https://www.hackingarticles.in/password-dumping-cheatsheet-windows/


Boas práticas com bloqueio de contas
23. Bloqueio de contas de serviço

Contas de serviço são aquelas contas que executam um executável, tarefa ou serviço, autenticação AD, etc.

Esse tipo de conta é muito comum e são largamente utilizados e geralmente têm uma senha definida para nunca expirar.

Essas contas geralmente acabam com sendo bem permissivas e, na maioria das vezes, são configuradas como membros do grupo de administradores de domínio (um alvo apetitoso para criminosos virtuais). Se a ideia é invadir um sistema, eu colocaria uma mira nesse tipo de contas.

Ruim, muito ruim

Às vezes, isso é sugerido pelos fornecedores de softwares e aplicações. Não permita que isso aconteça, existem maneiras de fazer funcionar sem acesso como domain admin.

Aqui estão algumas dicas para bloquear contas de serviço.

Use senhas fortes e longas

Dê acesso apenas ao que é necessário (para isso você precisa realizar inúmeros testes e homologações)

Tente evitar conceder direitos de administrador local

Não coloque em Admins do Domínio (jamais)

Negar logon localmente

Negar logon como um lote

Exigir que os fornecedores façam seu software funcionar sem direitos de administrador de domínio





configurando pliticas de senhas

Gerenciador do servidor > ferramentas > gerenciador de politica de grupo > botao direito sobre GPO > editar > configurações de computadores > politicas > configurações de windows > configurações de seguranca > politica de conta > politica de senha > habilitar politicas (exceto senhas com criptografia reversa)


Desabilitar o LLMNR

Gerenciador do servidor > ferramentas > gerenciador de politica de grupo > botao direito sobre GPO > editar > configurações de computadores > politicas > ões de seguranca > Modelos admnistrativos > Rede > cliente DNS > desativar resolução de nomes multicast > habilitar > aplicar > ok 


O protocolo NTLM
DESATIVANDO O NTLM EM AMBIENTE WINDOWS

O NTLM (NT Lan Manager) já existe a bastante tempo (é um protocolo antigo) e uma fonte de problemas para os defensores da rede, pois há uma série de problemas com essa forma de autenticação. As credenciais NTLM são geralmente armazenadas na memória e podem ser facilmente extraídas por um invasor usando uma ferramenta como o Mimikatz e as credenciais também podem ser usadas para passar os ataques de hash. Ferramentas como o Responder podem coletar credenciais NTLM pela rede simplesmente fingindo ser aquele compartilhamento de rede que um usuário tentou acessar dentro de sua rede. Portanto, livrar-se do NTLM deve ser uma prioridade para muitos, mas por onde começar?

Mesmo que Kerberos seja agora o protocolo de autenticação padrão, a maioria das empresas e organizações não podem simplesmente desligar o suporte NTML. Existem muitos aplicativos e sistemas que dependem da autenticação NTML para funcionar corretamente.

Então, o que você pode fazer como administrador de segurança para se afastar do NTLM? A primeira coisa é obter os fatos sobre quem e o que está realmente usando NTLM para autenticação. No Active Directory, há uma configuração de GPO específica que realmente permite que você audite todas as solicitações NTLM que seriam bloqueadas se o NTLM não fosse permitido. Esses eventos são registrados e podem ser visualizados no Visualizador de Eventos em seu controlador de domínio ou servidor membro. Ao habilitar essa trilha de auditoria, você pode começar a ver o que está realmente usando NTLM para autenticação. Se você tiver um ambiente grande com aplicativos legados, meu palpite é que haverá muitas entradas nesse log específico. O GPO, bem como os outros dois GPOs mencionados mais adiante nesta postagem, estão localizados em:

Caminho em PT-BR: Configuração do computador \ Configurações do Windows \ Configurações de segurança \ Políticas locais \ Opções de segurança

Segurança de rede: Restringir NTLM: Auditar a autenticação NTLM neste domínio

Caminho em ING: Computer Configuration\Windows Settings\Security Settings\Local Policies\Security Options

Network Security: Restrict NTLM: Audit NTLM authentication in this domain

Você pode definir o valor para auditar apenas contas de domínio ou todas as contas. Se você usar contas locais, certifique-se de definir o valor para todas as contas para um registro completo do uso de NTLM em seu ambiente.

Depois que o GPO está ativo, as solicitações de autenticação NTLM são registradas no log operacional localizado em Application and Services \ Microsoft \ Windows \ NTLM log em cada servidor onde o GPO está definido.

Em segundo lugar, depois de saber quem e o que usa NTLM em seu ambiente, veja se você pode migrá-los para usar Kerberos, talvez usando SPN. Por experiência pessoal, mesmo os grandes produtos comerciais às vezes ainda precisam migrar do NTLM para o Kerberos, alguns produtos exigem uma atualização ou alterações de configuração. Tudo se resume a saber quais aplicativos dependem da autenticação NTLM, que agora você tem uma forma de registrar e descobrir.

Provavelmente não será possível migrar alguns aplicativos e, se você tiver que mantê-los em execução, poderá abrir uma exceção apenas para esses aplicativos; essa é a terceira etapa. Ao permitir uma exceção, você pode permitir que um servidor específico use o NTLM para autenticação, mesmo que o NTLM tenha sido desabilitado em seu domínio. Isso é muito útil para minimizar suas necessidades de autenticação NTLM. Observe o GPO listado abaixo.

Segurança de rede: Restringir NTLM: Adicionar exceções de servidor para autenticação NTLM neste domínio

Agora que você sabe o que usa NTLM, migrou ou fez uma exceção para eles, pode finalmente desabilitar o NTLM completamente configurando este GPO.

Restringir NTLM: autenticação NTLM neste domínio

Esta é a etapa final necessária para desabilitar o NTLM para o seu domínio todos juntos, exceto para as exceções que você é forçado a fazer para aplicativos legados. Esperançosamente, você não precisa abrir nenhuma exceção.

Porém, esteja ciente de que, se você perdeu alguma coisa, há uma boa chance de que “alguma coisa” se quebre. Além disso, isso não é algo que você configura na sexta-feira de manhã e espera que seja feito na sexta-feira à tarde, isso leva tempo. No entanto, uma vez concluído, você tornou mais difícil para os invasores, pois o NTLM não está mais disponível como um vetor de ataque ou pelo menos foi reduzido drasticamente. O Kerberos também apresenta problemas, mas isso será discutido em outra postagem do blog.






Desativando O NTLM

Gerenciador do servidor > ferramentas > gerenciador de politica de grupo > botao direito sobre GPO > editar > configurações de computadores > politicas > configurações do windows > configurações de segurança > politicas locais > opções de segurança > segurança de rede: restringir NTLM Trafego NTLM de entrada > definir esta configuração > negar em todas as contas > aplicar > ok > segurança de rede: restringir NTLM fazer auditoria de autenticação NTLM neste domino > definir esta configuração > habilitar para tudo






Bloquear consulta de serviços DNS maliciosos
14. Use os serviços DNS para bloquear domínios maliciosos

Você pode evitar que muito tráfego malicioso entre em sua rede bloqueando pesquisas DNS maliciosas.

Sempre que um sistema precisa acessar a Internet, na maioria dos casos usará um nome de domínio.

Os computadores conversam entre si por endereço IP, portanto, os computadores usam DNS para mapear um nome de domínio para um endereço IP.

Existem vários serviços disponíveis que verificam as consultas DNS em busca de domínios maliciosos e os bloqueiam.

Como é que isso funciona?

Esses serviços DNS reúnem inteligência sobre domínios maliciosos de várias fontes públicas e privadas. Ao obter uma consulta sobre um domínio que sinalizou como malicioso, ele bloqueará o acesso quando o sistema tentar contatá-los.

Etapa - o cliente clica em um link que vai para examplenet

Etapa -  o cache local é verificado

Etapa -  O serviço DNS verifica se o domínio está em sua lista de ameaças, e retorna uma resposta de bloqueio.

No exemplo acima, uma vez que a consulta DNS retornou um bloco, nenhum tráfego malicioso jamais entrou na rede.

Aqui estão alguns dos serviços DNS seguros mais populares

Quad9

OpenDNS

Comodo Secure DNS

Além disso, a maioria dos sistemas IPS ( Intrusion Prevention Systems ) suportam a capacidade de verificar pesquisas de DNS em uma lista de domínios maliciosos.



https://www.youtube.com/watch?v=kURzoJ0Qj9o&feature=youtu.be


Boa prática sobre SMB (desativando o SMBv1)
24. Desative SMBv1

O SMBv1 está com 30 anos e a própria Microsoft diz que você deve parar de usá-lo (há muito que dizem isso).

SMB (Server Message Blocks) é um protocolo de compartilhamento de arquivos e impressoras de rede.

SMBv1 foi substituído pelos SMBv2 e SMBv3, porém muitas aplicações antigas (legado / Back Level) não funcionam corretamente com os protocolos SMBv2 e SMBv3.

Diversos malware podem se espalhar e explorar falhas no protocolo SMBv1.

Além disso, para os problemas de segurança com SMBv1 não é um protocolo eficiente, você perderá desempenho com esta versão antiga.

A partir do Windows 10 Fall Creators Update, SMBv1 será desabilitado por padrão. Ou seja, manter o ambiente atualizado já ajuda a manter a segurança.

Se você estiver executando uma versão mais antiga do Windows ou ainda no Windows 7, vai precisar considerar sua desativação com certa urgência.

Atenção: Antes de desativar definitivamente o SMBv1, você deve validar o impacto dentro de seu ambiente (saber quais aplicações dependem desse protocolo).

Você pode desabilitar o SMBv1 com a seguinte chave de registro:

HKEY_LOCAL_MACHINE\SYSTEM\CurrentControlSet\Services\LanmanServer\Parameters


https://learn.microsoft.com/pt-br/windows-server/storage/file-server/troubleshoot/detect-enable-and-disable-smbv1-v2-v3?tabs=server





Boas práticas - Parte 1
Melhores práticas

Quando planejar construir uma infraestrutura do Active Directory, é bom saber alguns truques para evitar problemas de segurança e configuração:

Renomear Admin do domínio – O primeiro usuário usado para iniciar um ataque é o administrador, portanto, sua primeira etapa é alterar o nome padrão do administrador de domínio. use uma nomenclatura completamente diferente dos padrões, como AdminContosoAD.

Senha forte para o administrador do domínio – Segurança, segurança e segurança! O administrador do domínio deve ter uma senha forte e as credenciais devem ser reservadas.

Credenciais dedicadas para TI – Uma das primeiras regras é separar credenciais padrão do gerenciamento para evitar escalonamento de segurança em caso de ataque externo.

Atribuir a Permissão Certa – Se você tem multi admins em sua infraestrutura é fundamental atribuir a permissão certa e credenciais únicas para cada usuário. Ninguém deve estar acima dos administradores de domínio para evitar a possibilidade de alterar o esquema do AD ou modificar o modelo de floresta.

Configurar GPO – Configurando a Diretiva de Grupo por Usuários e Computador, isso permite a granularidade perfeita. Lembre-se de evitar muitos GPOs, mas também de consolidar muitas configurações em um único GPO. Não use o GPO de Diretiva de Domínio Padrão!

Senha forte para usuários – Não apenas o administrador do domínio, todos os usuários devem seguir a complexidade da senha. Se você usa o Windows 10, uma ideia é configurar o Windows Hello for Business para simplificar o método de autenticação, sem reduzir a segurança.

Ativar Lixeira – A Lixeira foi introduzida no Windows Server 2008 R2 e é a maneira perfeita de restaurar um item em poucos segundos, sem executar uma restauração do AD.

Pelo menos dois controladores de domínio – Não importa se sua infraestrutura não é uma empresa, você deve ter dois controladores de domínio para evitar falhas críticas.

Remover Itens Obsoletos – Não se esqueça de limpar sua infraestrutura de usuários e computadores onde eles não estão mais presentes ou são necessários. Isso evita problemas ou problemas de segurança.

Um controlador de domínio não é um computador – não instale nada dentro de um controlador de domínio! Nenhum software, nenhum aplicativo de terceiros, nenhuma função, nada! Um Controlador de Domínio deve estar limpo!

Regra de Convenção de Nomenclatura – Defina uma convenção de nomenclatura antes de criar sua infraestrutura, sobre usuários, clientes, servidores, dispositivos e recursos (grupos, compartilhamento, mais). Isso ajudará você a simplesmente gerenciamento e escalabilidade.

Corrigir seus CDs – Os cybercriminosos são rápidos em explorar vulnerabilidades conhecidas, isso significa que deve manter sempre atualizada sua máquina. Planeje o horário correto para instalar as atualizações do Windows.

Auditoria – implante uma solução de auditoria para saber quem faz as alterações. Este não é um requisito GDPR, mas também é uma maneira de evitar problemas de segurança.





Boas práticas - Parte 2
Boas práticas para máquinas virtuais

O CD virtualizado é suportado – iniciando no Windows Server 2012, quando um novo recurso chamado VM Generation-ID foi adicionado, passou a ser suportada a instalação de um controlador de domínio como máquina virtual. Deve ser usado um CD físico? Depende da infra-estrutura, mas para a maioria das empresas a resposta é não. O importante é configurar a ação Iniciar como sempre iniciar em 0 segundos.

Não Checkpoint Virtualizados – Agora, os pontos de restauração para CD são suportados, mas seria melhor evitar essa operação.

Desativar sincronização de horário – os controladores de domínio esperam que estejam na parte superior da hierarquia de horário local e que o serviço de sincronização de horário do hospedeiro faça com que ele substitua qualquer outro conjunto de fontes para o serviço de tempo do Windows e isso pode causar problemas.

Não coloque controladores de domínio no estado de salvo – Quando uma máquina virtual sai de um estado salvo ou é revertida para um ponto de restauração, a única coisa que tem a garantia de corrigir seu relógio é o Serviço de Sincronização de Tempo. Mas, como informado antes, não deve ser habilitado em controladores de domínio virtualizados. Se o relógio se alterar muito, ele pode nunca se corrigir automaticamente.

Não converter o controlador de domínio – Não importa se você tem um CD físico ou virtual, o conversor está errado e não é suportado. Se deseja migrar do VMware para o Hyper-V, o controlador de domínio deve ser reinstalado do zero; mesmo caso ao quando tiver um DC físico.

Atualização no local – Como a conversão, a atualização não é suportada, portanto, se quiser instalar uma nova versão do Windows Server, planeje implantar uma nova máquina, adicione à floresta do AD, mova as funções FSMO e rebaixe o controlador de domínio mais antigo. Não há outra maneira!

Réplica – A réplica não deve ser usada na maioria dos casos. Se você tiver um site remoto de recuperação de falhas, pode ser muito melhor configurar outro controlador de domínio e usar o sistema de réplica do AD porque é melhor.



Boas práticas quanto a limpeza de objetos antigos
11. Limpar contas de usuário e computador antigas do Active Directory

Você precisa ter um procedimento em vigor para detectar contas de usuário e computador não utilizadas no Active Directory.

Você não quer um monte de contas não utilizadas no Active Directory, apenas esperando que um invasor descubra e use.

Isso também pode causar problemas com relatórios, correções e desacelerar a política de grupo.

Eu executo um processo a cada mês para detectar e remover contas não utilizadas.

Se o Active Directory não for limpo rotineiramente, pode ficar cheio de contas de computadores antigos.

Isso leva a grandes problemas, como relatórios imprecisos, lentidão da política de grupo, distribuição de software e problemas de patch, sincronização e assim por diante.

Em empresas de médio a grande porte, você pode se surpreender com a quantidade de computadores não utilizados que restam no Active Directory.

É por isso que é importante limpar o Active Directory de vez em quando.

Existem ferramentas (tanto de terceiros como desenvolvidas em powershell) que podem identificar objetos antigos e contas inativas. Primeiro, você precisa entender como esses métodos (ferramentas) funcionam. Existem dois atributos que podem ser usados ​​para localizar contas de computador antigas, são eles:

Hora do último logon: os computadores do Active Directory têm um atributo chamado lastLogonTimestamp, que armazena a última vez em que o computador foi conectado.

Idade da senha do computador: assim como as contas de usuário, os computadores têm uma senha. Eles são trocados automaticamente a cada 30 dias.

Neste curso faremos uso do powershell para coletar informações relacionadas a objetos.

get-adcomputer -filter * -properties passwordlastset | select name, passwordlastset | sort passwordlastset





Boas práticas para proteção da conta de Administrador do domínio
3. Proteja a conta do administrador de domínio

Cada domínio inclui uma conta de Administrador; por padrão, essa conta é membro do grupo Admins. Do Domínio.

A conta interna do Administrador deve ser usada apenas para configuração do domínio e recuperação de desastres (restauração do Active Directory).

Qualquer pessoa que exija acesso de nível administrativo a servidores ou Active Directory deve usar sua própria conta individual.

Ninguém deve saber a senha da conta do administrador de domínio. Defina uma senha muito longa com mais de 20 caracteres e bloqueie-a em um cofre. Novamente, o único momento em que isso é necessário é para fins de recuperação.

Além disso, a Microsoft tem várias recomendações para proteger a conta de administrador integrada. Essas configurações podem ser aplicadas à política de grupo e a todos os computadores.

Ativar a conta é confidencial e não pode ser delegada.

Habilitar o cartão inteligente é necessário para logon interativo

Negar acesso a este computador da rede

Negar logon como trabalho em lote

Negar logon como um serviço

Negar logon por meio de RDP



https://learn.microsoft.com/en-us/windows-server/identity/ad-ds/plan/security-best-practices/appendix-d--securing-built-in-administrator-accounts-in-active-directory



Boas práticas sobre atualizações de patches
13. Continua com gerenciamento de patch e verificação de vulnerabilidade

Os invasores são rápidos em explorar vulnerabilidades conhecidas.

Se você não faz a varredura e corrige regularmente as vulnerabilidades descobertas, você corre um risco muito maior de compreender.

Há um grande número de vulnerabilidades e ferramentas de varredura disponíveis, veja minha lista dos 6 melhores softwares de gerenciamento de patches comparados.

Dicas para gerenciamento contínuo de vulnerabilidade

Faça a varredura de todos os sistemas pelo menos uma vez por semana para identificar todas as vulnerabilidades potenciais.

Priorize a descoberta das varreduras de vulnerabilidade e primeiro corrija aquelas que apresentam vulnerabilidades conhecidas.

Implante atualizações de software automatizadas para sistemas operacionais

Implante automatizado atualizado para software de terceiros

Identifique o software desatualizado que não é mais compatível e atualize-o.


Novos recursos de segurança (infraestrutura crítica)
Execute a infraestrutura crítica no sistema operacional Windows mais recente

Com cada nova versão do sistema operacional Windows, a Microsoft inclui recursos e aprimoramentos de segurança integrados.

Apenas manter o sistema operacional mais recente aumentará a segurança geral.

Novos recursos de segurança no Server 2016

Máquinas virtuais protegidas

Just Enough Administration

Headless Windows Defender

Guarda de Credenciais

Device Guard






Duplo fator de autenticação para acesso remoto
16. Use a autenticação de dois fatores para acesso remoto

Contas comprometidas são muito comuns e podem fornecer aos invasores acesso remoto aos seus sistemas por meio de VPN, Citrix ou outros sistemas de acesso remoto.

Verifique seus logs do Office 365 ou ADFS, você ficará surpreso com quantas tentativas de login vêm da China e da Rússia.

Uma das melhores maneiras de se proteger contra contas comprometidas é a autenticação de dois fatores. Isso também ajudará contra ataques de spaying de senha.

Digamos que um usuário caiu em uma tentativa de phishing que pedia ao usuário para verificar seu nome de usuário e senha.

Agora o invasor tem as credenciais do Active Directory dos usuários. O invasor agora pode obter acesso a vários sistemas de qualquer lugar.

Se o usuário tiver dois fatores habilitados, isso pode impedir o acesso, mesmo que a conta tenha sido comprometida. O invasor precisaria do segundo conjunto de credenciais para fazer o login.

Realmente, não há como impedir que contas sejam comprometidas; há muitas maneiras de invasores obterem as credenciais.

Se estiver usando o Office 365 e dependendo de qual pacote você tem, o MFA pode estar incluído. Aproveite este recurso.

Soluções populares de autenticação de dois fatores

DUO

RSA

Microsoft MFA

https://www.eduardopopovici.com/2020/07/configurando-o-mfa-em-usuarios-do-azure.html





Boas práticas quando o assunto é Microsoft 365 e ambiente Cloud
19. Use o ADFS mais recente e os recursos de segurança do Azure

ADFS e Azure têm alguns excelentes recursos de segurança. Esses recursos ajudarão na divulgação de senhas, comprometimento de contas, phishing e assim por diante.

Não importa em que nível do Office 365 você esteja, existem alguns recursos que você deve examinar e considerar fortemente.

Claro, as assinaturas premium têm os melhores recursos de segurança e você pagará ($$$$$$) por isso.

Mas

A Microsoft melhora e adiciona novos recursos em todos os níveis (pelo menos isso é o que notei desde que comecei a usar o Office 365).

Aqui estão alguns recursos que valem a pena examinar:

Bloqueio inteligente - usa algoritmos para detectar atividade de logon incomum.

Bloqueio de IP - usa o banco de dados da Microsoft de endereços IP maliciosos conhecidos para bloquear logins.

Simulações de ataque - você deve fazer testes regulares de phishing para ajudar a treinar os usuários finais. A Microsoft estará lançando um software simulador de phishing muito em breve.

Autenticação MFA - solução de 2 fatores da Microsoft

Senhas banidas - verifica as senhas em uma lista conhecida

Azure AD Connect Health - fornece vários bons relatórios

Senhas erradas personalizadas - capacidade de adicionar senhas banidas personalizadas para verificação.

https://www.microsoft.com/en-us/microsoft-365/blog/2018/03/05/azure-ad-and-adfs-best-practices-defending-against-password-spray-attacks/



Boas práticas - utilizando linhas de base
25. Use linhas de base e benchmarks de segurança

Uma instalação padrão do sistema operacional Windows tem muitos recursos, serviços, configurações padrão e portas ativadas que não são seguras.

Essas configurações padronizadas devem ser analisadas em relação a benchmarks de segurança conhecidos.

O estabelecimento de uma configuração segura em todos os sistemas pode reduzir a superfície de ataque enquanto mantém a funcionalidade.

Existem vários recursos que fornecem referências de segurança.

A Microsoft possui um Kit de Ferramentas de Conformidade de Segurança que permite analisar e testar as linhas de base de configuração de segurança recomendadas pela Microsoft.

Outro ótimo recurso é o CIS SecureSuite

Ele também fornece linhas de base de configuração de segurança. Além disso, fornece ferramentas que podem varrer um sistema e fornecer um relatório sobre as falhas.

A maioria das configurações recomendadas pode ser definida usando a Política de Grupo e implantada em todos os computadores.

https://www.linkedin.com/pulse/onde-anda-gest%25C3%25A3o-em-seguran%25C3%25A7a-da-informa%25C3%25A7%25C3%25A3o-uilson-souza-mba/
https://learn.microsoft.com/pt-br/windows-server/identity/ad-ds/plan/security-best-practices/best-practices-for-securing-active-directory
https://www.solarwinds.com/server-application-monitor/use-cases/active-directory-monitor?CMP=BIZ-HAD-ADP-SW_WW_X_PP_PPD_LD_EN_HLTH_SW-SAM-X_X_Tools_List_X-ADHC_Topics
https://www.cisecurity.org/cis-securesuite
https://www.microsoft.com/en-us/download/details.aspx?id=55319









https://www.blackhat.com/docs/us-16/materials/us-16-Metcalf-Beyond-The-MCSE-Active-Directory-For-The-Security-Professional-wp.pdf